# HoloPatcher.NET Rules and Conventions for AI LLM agents

## ⚠️ CRITICAL: Git Commit Requirement ⚠️

**MANDATORY FOR ALL AI AGENTS**: After making ANY changes to files in this repository, you MUST:

1. **Stage all modified files**: `git add <file1> <file2> ...` (or `git add .` for all changes)
2. **Commit with a descriptive message**: `git commit -m "type: descriptive message"`
3. **Verify the commit succeeded**: Check that `git commit` returns successfully with no errors

**This is NOT optional.** Do NOT summarize changes without committing them. Do NOT skip this step. Every code change, file modification, or configuration update MUST be committed before you consider the task complete.

**NEVER use `git add .` or `git add -A` to stage changes.** Always stage files individually. This is because we may have multiple agents working on multiple files simultaneously.

**Commit message format**: Use conventional commits format:

- `fix:` for bug fixes
- `feat:` for new features
- `refactor:` for code refactoring
- `docs:` for documentation changes
- `chore:` for maintenance tasks
- `test:` for test changes

Example: `git commit -m "fix: correct finalize job condition in workflow"`

---

## Documentation

When creating ANY new `.md` files, always follow these guidelines:

- Always place within `docs`
- Never report on progression (changes and what still remains to be done).
- Exclusively provide public-facing documentation, something an end user will need to read if they want to either develop for PyKotor or work with it.

Please do not create .md documentation unless it delivers public-facing information or authoritative gameplay/platform references that an end user or developer genuinely needs for PyKotor or the games themselves.

## Helper Scripts

- Always place within `scripts`
- Should be idempotent and flexible enough to be used for a plethora of scenarios, not just whatever the task you're working on involves.
- Do not delete helper .py/.ps1/.sh scripts when you are finished with them; keep them in scripts folder

## File Organization

**CRITICAL: Repository Root Cleanup**

AI agents MUST maintain proper file organization in the repository root:

1. **Documentation Files**:
   - ALL `.md` documentation files (except `README.md`) MUST be placed in `./docs`
   - `README.md` is the ONLY markdown file allowed in the repository root
   - When creating new documentation, always place it in `./docs`
   - If you find documentation files in the root (other than `README.md`), move them to `./docs`

2. **Script Files**:
   - ALL script files (`.ps1`, `.sh`, `.py`, `.bat`, `.cmd`, etc.) MUST be placed in `./scripts`
   - When creating new scripts, always place them in `./scripts`
   - If you find script files in the root, move them to `./scripts`

3. **Root Directory**:
   - The root directory should only contain:
     - `README.md` (the only allowed markdown file in root)
     - Solution files (`.sln`)
     - Project configuration files (`.csproj`, `.props`, etc.)
     - Build artifacts and temporary files (as appropriate)
     - Essential configuration files (`.gitignore`, `.cursorrules`, etc.)

**When creating or moving files, always verify they are in the correct location according to these rules.**

## C# Language Version Requirements

**CRITICAL: The maximum C# language version allowed is 7.3. NEVER upgrade to C# 8.0 or higher.**

This is a hard requirement for .NET Framework 4.x compatibility. The following C# 8+ features are FORBIDDEN:

- Nullable reference types (`string?`, `object?`, etc.)
- Switch expressions
- Using declarations (must use `using` blocks)
- Default interface implementations
- Async streams
- Indices and ranges (`^1`, `..`)
- Null-coalescing assignment (`??=`)
- Pattern matching enhancements (property patterns, tuple patterns, positional patterns)
- Static local functions

When fixing code, convert C# 8+ syntax to C# 7.3 compatible alternatives, including but not limited to:

- `string?` → `string` (use `[CanBeNull]` attribute if needed and add `using JetBrains.Annotations;` if not already present)
- `value!` → `value` (remove null-forgiving operator)
- Switch expressions → switch statements
- `using var x = ...` → `using (var x = ...) { }`
- `namespace SomeNamespace;` → `namespace SomeNamespace { ... }`

## 1:1 Porting Requirements

When porting code from Python (vendor/PyKotor) to C#:

1. **Exact Code Matching**: All code must match the Python source 1:1, including:
   - Logic and control flow
   - Variable names (converted to C# naming conventions where necessary)
   - Comments (exact text, no additional comments)
   - Whitespace structure (where applicable)

2. **Comments**:
   - DO NOT add explanatory comments about how Python works
   - DO NOT add comments explaining the conversion
   - DO NOT add "1:1 port" comments
   - DO NOT add "TODO" comments unless they exist in Python
   - ONLY include comments that exist in the Python source
   - Match comment text exactly, including docstrings

3. **No Additional Code**:
   - DO NOT add helper methods unless they exist in Python
   - DO NOT add validation unless it exists in Python
   - DO NOT add error handling unless it exists in Python
   - DO NOT add optimizations unless they exist in Python

4. **Assumptions**:
   - If Python tests pass, the Python implementation is correct
   - If C# tests fail, the C# code does not match Python
   - Fix failures by matching Python exactly, not by "improving" the code

5. **File Structure**:
   - Match Python file organization where possible
   - Match class/method organization where possible

6. **Error Messages**:
   - Match Python error messages exactly (converted to C# string formatting)

## Testing

- All ported tests must pass
- Failing tests indicate the C# code does not match Python
- Fix by matching Python exactly, not by changing test expectations

## Matching Implementations

**CRITICAL: Source Lookup & Commenting**

Before making ANY edit to ANY file, you MUST locate the corresponding source code in the `vendor` directory to ensure 1:1 parity.

1. **Identify the Source of Truth**:
   - **General Logic / Compiler**: Use `vendor/PyKotor` (e.g., `Libraries/PyKotor/...`).
   - **Decompiler (NCS -> NSS)**: Use `vendor/DeNCS` or `vendor/NCSDecomp`. **IGNORE PyKotor** for decompilation logic.

2. **Add Precise Reference Comments**:
   Every ported method or logic block MUST have a comment with:
   - **EXACT Relative Path**: Path to the source file (e.g., `Libraries/PyKotor/src/pykotor/extract/twoda.py`).
   - **EXACT Line Numbers**: Specific line number or range.
   - **Code Snippet**: Include 1-2 lines of the ORIGINAL source code to prove you checked it.

   **Format**:

   ```csharp
   // Matching PyKotor implementation at Libraries/PyKotor/src/pykotor/module/module.py:45
   // Original: self._name = name
   this._name = name;
   ```
